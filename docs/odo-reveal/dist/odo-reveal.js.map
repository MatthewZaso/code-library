{"version":3,"file":"odo-reveal.js","sources":["../src/reveal.js"],"sourcesContent":["/**\n * @fileoverview Fade elements in and up when they come into view. Waits for\n * images inside the main element to load before triggering the fade.\n *\n * @author Glen Cheney <glen@odopod.com>\n *\n * TODO: Add a (better) way to ignore/add/remove images or videos.\n */\n\nimport OdoDevice from '@odopod/odo-device';\nimport OdoViewport from '@odopod/odo-viewport';\nimport { getPercentageOption, isNativeAndroid, onTransitionEnd } from '@odopod/odo-helpers';\n\nclass Reveal {\n  /**\n   * @param {Element} element Main element for the module.\n   * @constructor\n   */\n  constructor(element) {\n    this.element = element;\n    this.images = this._getDependentImages();\n    this._numImages = this.images.length;\n    this._loadedImages = 0;\n    this._imageCompleteHandler = this._imageComplete.bind(this);\n    this._ready = new Promise((resolve) => {\n      this._resolve = resolve;\n    });\n\n    if (this._numImages > 0) {\n      this.images.forEach((image) => {\n        image.addEventListener('load', this._imageCompleteHandler);\n        image.addEventListener('error', this._imageCompleteHandler);\n      });\n    } else {\n      this._resolve();\n    }\n\n    // To avoid blank text while scrolling on native Android,\n    // the type is faded in immediately and not given to the viewport\n    // to track.\n    if (Reveal.HAS_SCROLL_ANIMATION) {\n      /**\n       * Viewport id to remove it later.\n       * @type {string}\n       */\n      this.id = OdoViewport.add({\n        element,\n        threshold: getPercentageOption(element.getAttribute('data-threshold'), '25%'),\n        enter: this._enteredView.bind(this),\n      });\n    } else {\n      this._show();\n    }\n  }\n\n  /**\n   * Get all images within the main element which do not have the \"ignore\" class\n   * on a parent element.\n   * @return {Array.<HTMLImageElement>}\n   * @private\n   */\n  _getDependentImages() {\n    const images = Array.from(this.element.querySelectorAll('img'));\n    return images.filter(img => img.closest('.' + Reveal.ClassName.IGNORE) === null);\n  }\n\n  /**\n   * Element is in view. Wait until all images have finished loading then animate\n   * the targets in.\n   */\n  _enteredView() {\n    this._ready.then(this._show.bind(this));\n  }\n\n  /**\n   * Main element came into view. Add the fade in class to the main element which\n   * triggers all type to start transitioning.\n   * @private\n   */\n  _show() {\n    this.element.classList.add(Reveal.ClassName.IN);\n\n    const targetSelector = '.' + Reveal.ClassName.TARGET;\n    const targets = Array.from(this.element.querySelectorAll(targetSelector));\n\n    // Listen transition end on each target and add a class which removes\n    // the transform and layer promotion from it.\n    targets.forEach((el) => {\n      onTransitionEnd(el, this._handleShown, null, OdoDevice.Dom.TRANSFORM);\n    });\n\n    this.dispose();\n  }\n\n  /**\n   * Add the done class which removes the transforms and layer promotion.\n   * @private\n   */\n  _handleShown(evt) {\n    evt.target.classList.add(Reveal.ClassName.DONE);\n  }\n\n  /**\n   * An image loaded or failed to load. If it was the last image, resolve the\n   * promise waiting for all images to finish.\n   * @private\n   */\n  _imageComplete() {\n    this._loadedImages += 1;\n\n    if (this._loadedImages === this._numImages) {\n      this._resolve();\n    }\n  }\n\n  /**\n   * Remove the type animations from the viewport watcher. Has no effect if the\n   * element has already come into view.\n   */\n  dispose() {\n    OdoViewport.remove(this.id);\n\n    this.images.forEach((image) => {\n      image.removeEventListener('load', this._imageCompleteHandler);\n      image.removeEventListener('error', this._imageCompleteHandler);\n    });\n\n    this.images = null;\n    this.element = null;\n  }\n\n  /**\n   * Auto-initialize all odo reveal elements currently on the page.\n   * @param {Element|Document} [context] Optional context to initialize elements within.\n   * @return {Array.<Reveal>}\n   */\n  static initializeAll(context = document) {\n    return Array.from(\n      context.querySelectorAll('.odo-reveal'),\n      element => new Reveal(element),\n    );\n  }\n}\n\n/**\n * Whether or not to add the main element to the Viewport watcher. By default,\n * no native Android browsers are registered. The type will fade in immediately.\n * @type {boolean}\n */\nReveal.HAS_SCROLL_ANIMATION = !isNativeAndroid(navigator.userAgent);\n\n/** @enum {string} */\nReveal.ClassName = {\n  TARGET: 'odo-reveal__target',\n  IN: 'odo-reveal--shown',\n  DONE: 'odo-reveal--done',\n  IGNORE: 'odo-reveal__ignore',\n};\n\nexport default Reveal;\n"],"names":["Reveal","element","images","_getDependentImages","_numImages","length","_loadedImages","_imageCompleteHandler","_imageComplete","bind","_ready","Promise","resolve","_resolve","forEach","image","addEventListener","HAS_SCROLL_ANIMATION","id","OdoViewport","add","getPercentageOption","getAttribute","_enteredView","_show","Array","from","querySelectorAll","filter","img","closest","ClassName","IGNORE","then","classList","IN","targetSelector","TARGET","targets","el","_handleShown","OdoDevice","Dom","TRANSFORM","dispose","evt","target","DONE","remove","removeEventListener","initializeAll","context","document","isNativeAndroid","navigator","userAgent"],"mappings":"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"}