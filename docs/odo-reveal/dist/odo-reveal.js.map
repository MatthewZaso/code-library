{"version":3,"file":"odo-reveal.js","sources":["../src/reveal.js"],"sourcesContent":["/**\n * @fileoverview Fade elements in and up when they come into view. Waits for\n * images inside the main element to load before triggering the fade.\n *\n * @author Glen Cheney <glen@odopod.com>\n *\n * TODO: Add a (better) way to ignore/add/remove images or videos.\n */\n\nimport OdoDevice from '@odopod/odo-device';\nimport OdoViewport from '@odopod/odo-viewport';\nimport { animation, browser, utilities } from '@odopod/odo-helpers';\n\n/**\n * @param {Element} element Main element for the module.\n * @constructor\n */\nclass Reveal {\n  constructor(element) {\n    this.element = element;\n    this.images = this._getDependentImages();\n    this._numImages = this.images.length;\n    this._loadedImages = 0;\n    this._imageCompleteHandler = this._imageComplete.bind(this);\n    this._ready = new Promise((resolve) => {\n      this._resolve = resolve;\n    });\n\n    if (this._numImages > 0) {\n      this.images.forEach((image) => {\n        image.addEventListener('load', this._imageCompleteHandler);\n        image.addEventListener('error', this._imageCompleteHandler);\n      });\n    } else {\n      this._resolve();\n    }\n\n    // To avoid blank text while scrolling on native Android,\n    // the type is faded in immediately and not given to the viewport\n    // to track.\n    if (Reveal.HAS_SCROLL_ANIMATION) {\n      this.id = OdoViewport.add({\n        element,\n        threshold: utilities.getPercentageOption(element.getAttribute('data-threshold'), '25%'),\n        enter: this._enteredView.bind(this),\n      });\n    } else {\n      this._show();\n    }\n  }\n\n  /**\n   * Get all images within the main element which do not have the \"ignore\" class\n   * on a parent element.\n   * @return {Array.<HTMLImageElement>}\n   * @private\n   */\n  _getDependentImages() {\n    const images = Array.from(this.element.querySelectorAll('img'));\n    return images.filter(img => img.closest('.' + Reveal.ClassName.IGNORE) === null);\n  }\n\n  /**\n   * Element is in view. Wait until all images have finished loading then animate\n   * the targets in.\n   */\n  _enteredView() {\n    this._ready.then(this._show.bind(this));\n  }\n\n  /**\n   * Main element came into view. Add the fade in class to the main element which\n   * triggers all type to start transitioning.\n   * @private\n   */\n  _show() {\n    this.element.classList.add(Reveal.ClassName.IN);\n\n    const targetSelector = '.' + Reveal.ClassName.TARGET;\n    const targets = Array.from(this.element.querySelectorAll(targetSelector));\n\n    // Listen transition end on each target and add a class which removes\n    // the transform and layer promotion from it.\n    targets.forEach((el) => {\n      animation.onTransitionEnd(el, this._handleShown, null, OdoDevice.Dom.TRANSFORM);\n    });\n\n    this.dispose();\n  }\n\n  /**\n   * Add the done class which removes the transforms and layer promotion.\n   * @private\n   */\n  _handleShown(evt) {\n    evt.target.classList.add(Reveal.ClassName.DONE);\n  }\n\n  /**\n   * An image loaded or failed to load. If it was the last image, resolve the\n   * promise waiting for all images to finish.\n   * @private\n   */\n  _imageComplete() {\n    this._loadedImages += 1;\n\n    if (this._loadedImages === this._numImages) {\n      this._resolve();\n    }\n  }\n\n  /**\n   * Remove the type animations from the viewport watcher. Has no effect if the\n   * element has already come into view.\n   */\n  dispose() {\n    OdoViewport.remove(this.id);\n\n    this.images.forEach((image) => {\n      image.removeEventListener('load', this._imageCompleteHandler);\n      image.removeEventListener('error', this._imageCompleteHandler);\n    });\n\n    this.images = null;\n    this.element = null;\n  }\n\n  /**\n   * Auto-initialize all odo reveal elements currently on the page.\n   * @param {Element} [context] Optional context to initialize elements within.\n   * @return {Array.<Reveal>}\n   */\n  static initializeAll(context = document) {\n    return Array.from(context.querySelectorAll('.odo-reveal'))\n      .map(element => new Reveal(element));\n  }\n}\n\n/**\n * Whether or not to add the main element to the Viewport watcher. By default,\n * no native Android browsers are registered. The type will fade in immediately.\n * @type {boolean}\n */\nReveal.HAS_SCROLL_ANIMATION = !browser.isNativeAndroid(navigator.userAgent);\n\n/** @enum {string} */\nReveal.ClassName = {\n  TARGET: 'odo-reveal__target',\n  IN: 'odo-reveal--shown',\n  DONE: 'odo-reveal--done',\n  IGNORE: 'odo-reveal__ignore',\n};\n\nexport default Reveal;\n"],"names":["Reveal","element","images","_getDependentImages","_numImages","length","_loadedImages","_imageCompleteHandler","_imageComplete","bind","_ready","Promise","resolve","_resolve","forEach","image","addEventListener","HAS_SCROLL_ANIMATION","id","OdoViewport","add","utilities","getPercentageOption","getAttribute","_enteredView","_show","Array","from","querySelectorAll","filter","img","closest","ClassName","IGNORE","then","classList","IN","targetSelector","TARGET","targets","el","onTransitionEnd","_handleShown","OdoDevice","Dom","TRANSFORM","dispose","evt","target","DONE","remove","removeEventListener","initializeAll","context","document","map","browser","isNativeAndroid","navigator","userAgent"],"mappings":"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"}