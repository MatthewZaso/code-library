{"version":3,"file":"odo-background-video.js","sources":["../src/background-video.js"],"sourcesContent":["/**\n * @fileoverview Add a odo video component which plays in the background when\n * the element comes into view and falls back to an image if the browser cannot\n * autoplay video.\n *\n * @author Glen Cheney <glen@odopod.com>\n * @author Evan Vaughn\n */\n\nimport OdoVideo from '@odopod/odo-video';\nimport OdoWindowEvents from '@odopod/odo-window-events';\nimport OdoViewport from '@odopod/odo-viewport';\nimport OdoObjectFit from '@odopod/odo-object-fit';\nimport OdoResponsiveImages from '@odopod/odo-responsive-images';\n\nclass BackgroundVideo {\n  constructor(element) {\n    /**\n     * Main element.\n     * @type {Element}\n     */\n    this.element = element;\n\n    /**\n     * Odo video wrapper element.\n     * @type {Element}\n     */\n    this._odoVideoElement = this.element.querySelector('.odo-video');\n\n    /**\n     * Fallback image wrapper element.\n     * @type {Element}\n     */\n    this._odoImageElement = this.element.querySelector('.odo-background-video__fallback-img');\n\n    /**\n     * Whether the media elment is the video or not.\n     * @type {boolean}\n     */\n    this.isVideo = null;\n\n    /**\n     * A promise which resolves when the video loads or when the image loads.\n     * @type {Promise}\n     */\n    this.ready = new Promise((resolve) => {\n      this._resolve = resolve;\n    });\n\n    if (this._odoVideoElement) {\n      OdoVideo.autoplay.then(this._handleAutoplayResult.bind(this));\n    } else {\n      this._cannotAutoplay();\n    }\n\n    // Cover it on resizes.\n    this._resizeId = OdoWindowEvents.onResize(this._handleResize.bind(this));\n  }\n\n  _handleAutoplayResult(canAutoplay) {\n    if (canAutoplay) {\n      this._canAutoplay();\n    } else {\n      this._cannotAutoplay();\n    }\n  }\n\n  /**\n   * Browser supports autoplay. When the video enters the viewport it will autoplay.\n   */\n  _canAutoplay() {\n    // Reveal video element.\n    this._odoVideoElement.classList.remove('hidden');\n\n    // Initialize odo component.\n    this._video = new OdoVideo(this._odoVideoElement, {\n      controls: OdoVideo.Controls.NONE,\n      pauseOnClick: false,\n    });\n\n    this._viewportId = OdoViewport.add({\n      element: this._odoVideoElement,\n      threshold: '20%',\n      enter: this._play.bind(this),\n      exit: this._pause.bind(this),\n    });\n\n    const _this = this;\n\n    function done() {\n      this.removeEventListener('loadedmetadata', done);\n      this.removeEventListener('error', done);\n      _this._ready();\n    }\n\n    const videoEl = this._video.getVideoElement();\n    videoEl.addEventListener('loadedmetadata', done);\n    videoEl.addEventListener('error', done);\n\n    this._video.listenOnData(\n      OdoVideo.VideoEvents.LOADED_DATA,\n      this._showFirstFrame.bind(this),\n    );\n\n    this.isVideo = true;\n\n    // Use js to cover the video.\n    OdoObjectFit.cover(videoEl);\n  }\n\n  /**\n   * Browser doesn't support autoplaying video without user interaction, fall back\n   * to a static responsive image.\n   */\n  _cannotAutoplay() {\n    const img = this._odoImageElement.querySelector('img');\n    this._odoImageElement.classList.add('odo-responsive-img');\n    this._odoImageElement.classList.remove('hidden');\n\n    // Tell Odo about our new responsive image.\n    OdoResponsiveImages.add(this._odoImageElement);\n\n    const _this = this;\n\n    function done() {\n      this.removeEventListener('load', done);\n      this.removeEventListener('error', done);\n      _this._ready();\n    }\n\n    img.addEventListener('load', done);\n    img.addEventListener('error', done);\n\n    this.isVideo = false;\n\n    // Use js to cover the image.\n    OdoObjectFit.cover(img);\n  }\n\n  _play() {\n    this._video.play();\n  }\n\n  _pause() {\n    this._video.pause();\n  }\n\n  /**\n   * The image has loaded or the video has started playing.\n   * @private\n   */\n  _ready() {\n    this._resolve();\n  }\n\n  /**\n   * Set the video the first frame to trigger it to show up in Safari 8.\n   *\n   * TODO: this doesn't work when preload=\"metadata\" in Safari because it doesn't\n   * even download the first frame.\n   *\n   * @private\n   */\n  _showFirstFrame() {\n    if (!this._video.isPlaying) {\n      this._video.getVideoElement().currentTime = 0;\n    }\n  }\n\n  _handleResize() {\n    OdoObjectFit.cover(this.mediaElement);\n  }\n\n  get videoElement() {\n    return this._odoVideoElement;\n  }\n\n  get imageElement() {\n    return this._odoImageElement;\n  }\n\n  get mediaElement() {\n    if (this.isVideo) {\n      return this._video.getVideoElement();\n    }\n\n    return this._odoImageElement.querySelector('img');\n  }\n\n  dispose() {\n    OdoWindowEvents.remove(this._resizeId);\n    this._resizeId = null;\n\n    if (this._video) {\n      this._video.dispose();\n      OdoViewport.remove(this._viewportId);\n      this._viewportId = null;\n      this.isVideo = null;\n    }\n  }\n}\n\nexport default BackgroundVideo;\n"],"names":["BackgroundVideo","element","_odoVideoElement","querySelector","_odoImageElement","isVideo","ready","Promise","resolve","_resolve","OdoVideo","autoplay","then","_handleAutoplayResult","bind","_cannotAutoplay","_resizeId","OdoWindowEvents","onResize","_handleResize","canAutoplay","_canAutoplay","classList","remove","_video","controls","Controls","NONE","pauseOnClick","_viewportId","OdoViewport","add","threshold","enter","_play","exit","_pause","_this","done","removeEventListener","_ready","videoEl","getVideoElement","addEventListener","listenOnData","VideoEvents","LOADED_DATA","_showFirstFrame","OdoObjectFit","cover","img","OdoResponsiveImages","play","pause","isPlaying","currentTime","mediaElement","dispose"],"mappings":"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"}