{"version":3,"file":"odo-background-video.js","sources":["../src/background-video.js"],"sourcesContent":["/**\n * @fileoverview Add a odo video component which plays in the background when\n * the element comes into view and falls back to an image if the browser cannot\n * autoplay video.\n *\n * @author Glen Cheney <glen@odopod.com>\n * @author Evan Vaughn\n */\n\nimport OdoVideo from '@odopod/odo-video';\nimport OdoWindowEvents from '@odopod/odo-window-events';\nimport OdoViewport from '@odopod/odo-viewport';\nimport OdoObjectFit from '@odopod/odo-object-fit';\nimport OdoResponsiveImages from '@odopod/odo-responsive-images';\n\nclass BackgroundVideo {\n  constructor(element) {\n    /**\n     * Main element.\n     * @type {Element}\n     */\n    this.element = element;\n\n    /**\n     * Odo video wrapper element.\n     * @type {Element}\n     */\n    this._odoVideoElement = this.element.querySelector('.odo-video');\n\n    /**\n     * Fallback image wrapper element.\n     * @type {Element}\n     */\n    this._odoImageElement = this.element.querySelector('.odo-background-video__fallback-img');\n\n    /**\n     * Whether the media elment is the video or not.\n     * @type {boolean}\n     */\n    this.isVideo = null;\n\n    /**\n     * A promise which resolves when the video loads or when the image loads.\n     * @type {Promise}\n     */\n    this.ready = new Promise((resolve) => {\n      this._resolve = resolve;\n    });\n\n    if (this._odoVideoElement) {\n      OdoVideo.autoplay.then(this._handleAutoplayResult.bind(this));\n    } else {\n      this._cannotAutoplay();\n    }\n\n    // Cover it on resizes.\n    this._resizeId = OdoWindowEvents.onResize(this._handleResize.bind(this));\n  }\n\n  _handleAutoplayResult(canAutoplay) {\n    if (canAutoplay) {\n      this._canAutoplay();\n    } else {\n      this._cannotAutoplay();\n    }\n  }\n\n  /**\n   * Browser supports autoplay. When the video enters the viewport it will autoplay.\n   */\n  _canAutoplay() {\n    // Reveal video element.\n    this._odoVideoElement.classList.remove('hidden');\n\n    // Initialize odo component.\n    this._video = new OdoVideo(this._odoVideoElement, {\n      controls: OdoVideo.Controls.NONE,\n      pauseOnClick: false,\n    });\n\n    this._viewportId = OdoViewport.add({\n      element: this._odoVideoElement,\n      threshold: '20%',\n      enter: this._play.bind(this),\n      exit: this._pause.bind(this),\n    });\n\n    const _this = this;\n\n    function done() {\n      this.removeEventListener('loadedmetadata', done);\n      this.removeEventListener('error', done);\n      _this._ready();\n    }\n\n    const videoEl = this._video.getVideoElement();\n    videoEl.addEventListener('loadedmetadata', done);\n    videoEl.addEventListener('error', done);\n\n    this._video.listenOnData(\n      OdoVideo.VideoEvents.LOADED_DATA,\n      this._showFirstFrame.bind(this),\n    );\n\n    this.isVideo = true;\n\n    // Use js to cover the video.\n    OdoObjectFit.cover(videoEl);\n  }\n\n  /**\n   * Browser doesn't support autoplaying video without user interaction, fall back\n   * to a static responsive image.\n   */\n  _cannotAutoplay() {\n    const img = this._odoImageElement.querySelector('img');\n    this._odoImageElement.classList.add('odo-responsive-img');\n    this._odoImageElement.classList.remove('hidden');\n\n    // Tell Odo about our new responsive image.\n    OdoResponsiveImages.add(this._odoImageElement);\n\n    const _this = this;\n\n    function done() {\n      this.removeEventListener('load', done);\n      this.removeEventListener('error', done);\n      _this._ready();\n    }\n\n    img.addEventListener('load', done);\n    img.addEventListener('error', done);\n\n    this.isVideo = false;\n\n    // Use js to cover the image.\n    OdoObjectFit.cover(img);\n  }\n\n  _play() {\n    this._video.play();\n  }\n\n  _pause() {\n    this._video.pause();\n  }\n\n  /**\n   * The image has loaded or the video has started playing.\n   * @private\n   */\n  _ready() {\n    this._resolve();\n  }\n\n  /**\n   * Set the video the first frame to trigger it to show up in Safari 8.\n   *\n   * TODO: this doesn't work when preload=\"metadata\" in Safari because it doesn't\n   * even download the first frame.\n   *\n   * @private\n   */\n  _showFirstFrame() {\n    if (!this._video.isPlaying) {\n      this._video.getVideoElement().currentTime = 0;\n    }\n  }\n\n  _handleResize() {\n    OdoObjectFit.cover(this.mediaElement);\n  }\n\n  get videoElement() {\n    return this._odoVideoElement;\n  }\n\n  get imageElement() {\n    return this._odoImageElement;\n  }\n\n  get mediaElement() {\n    if (this.isVideo) {\n      return this._video.getVideoElement();\n    }\n\n    return this._odoImageElement.querySelector('img');\n  }\n\n  dispose() {\n    OdoWindowEvents.remove(this._resizeId);\n    this._resizeId = null;\n\n    if (this._video) {\n      this._video.dispose();\n      OdoViewport.remove(this._viewportId);\n      this._viewportId = null;\n      this.isVideo = null;\n    }\n  }\n}\n\nexport default BackgroundVideo;\n"],"names":["BackgroundVideo","element","_odoVideoElement","querySelector","_odoImageElement","isVideo","ready","Promise","resolve","_resolve","autoplay","then","_handleAutoplayResult","bind","_cannotAutoplay","_resizeId","OdoWindowEvents","onResize","_handleResize","canAutoplay","_canAutoplay","classList","remove","_video","OdoVideo","Controls","NONE","_viewportId","OdoViewport","add","_play","_pause","_this","done","removeEventListener","_ready","videoEl","getVideoElement","addEventListener","listenOnData","VideoEvents","LOADED_DATA","_showFirstFrame","cover","img","play","pause","isPlaying","currentTime","mediaElement","dispose"],"mappings":"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"}