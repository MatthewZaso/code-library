!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("picturefill"),require("@odopod/odo-viewport")):"function"==typeof define&&define.amd?define(["picturefill","@odopod/odo-viewport"],t):e.OdoResponsiveImages=t(e.picturefill,e.OdoViewport)}(this,function(e,t){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var o=function(e,t,o){var r,a,n,i,s;function d(){var l=Date.now()-i;l<t&&l>=0?r=setTimeout(d,t-l):(r=null,o||(s=e.apply(n,a),n=a=null))}null==t&&(t=100);var l=function(){n=this,a=arguments,i=Date.now();var l=o&&!r;return r||(r=setTimeout(d,t)),l&&(s=e.apply(n,a),n=a=null),s};return l.clear=function(){r&&(clearTimeout(r),r=null)},l.flush=function(){r&&(s=e.apply(n,a),n=a=null,clearTimeout(r),r=null)},l},r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function a(e){return Array.isArray(e)?e:e&&"number"==typeof e.length?Array.from(e):[e]}var n=function(){function n(){r(this,n),this.ClassName={IMAGE:"odo-responsive-img",LOADED:"odo-responsive-img--loaded"},this.images=[],this._imageLoadHandler=this._handleImageLoad.bind(this),this._imageInViewHandler=this._handleImageInView.bind(this),this.updateOffsets=o(this._update,n.DEBOUNCE_TIME)}return n.prototype.initialize=function(){this._add(Array.from(document.querySelectorAll("."+this.ClassName.IMAGE+":not(picture)")))},n.prototype._add=function(e){var o=this,r=e.map(function(e){return o._getViewportOptions(e)}),a=t.add(r);this.images=this.images.concat(a.map(function(t,o){return{id:t,element:e[o]}}))},n.prototype._getViewportOptions=function(e){return{element:e,threshold:e.getAttribute("data-threshold")||0,enter:this._imageInViewHandler}},n.prototype._handleImageInView=function(e){this._loadImage(e.element)},n.prototype._loadImage=function(t){var o=t.querySelector("img");if(!o)throw new Error("Unable to find <img> element within Odo Responsive Images placeholder.");var r=o.getAttribute("data-srcset");if(null!==r)o.srcset=r,o.setAttribute("srcset",r),o.removeAttribute("data-srcset"),t._odoResponsiveImageUsed=!0;else{var a=t.parentNode,n=document.createElement("picture");n.className=t.className,function(e,t){for(var o=document.createDocumentFragment(),r=Array.from(e.childNodes),a=0;a<r.length;a++)"NOSCRIPT"!==r[a].nodeName&&o.appendChild(r[a]);t.appendChild(o)}(t,n);var i=t.getAttribute("data-type");i&&n.setAttribute("data-type",i),o=n.querySelector("img"),a.replaceChild(n,t),n._odoResponsiveImageUsed=!0}this._removeImageEntry(t),this.isImageLoaded(o)&&setTimeout(this._handleImageLoad.bind(this,{target:o}),30),o.addEventListener("load",this._imageLoadHandler,!1),o.addEventListener("error",this._imageLoadHandler,!1),e({elements:[o]})},n.prototype._getImageIndexByPlaceholder=function(e){for(var t=null,o=0,r=this.images.length;o<r;o++)if(this.images[o].element===e){t=o;break}return t},n.prototype._removeImageEntry=function(e){var o=this._getImageIndexByPlaceholder(e);null!==o&&(t.remove(this.images[o].id),this.images.splice(o,1))},n.prototype.isImageLoaded=function(e){return e.naturalWidth>0},n.prototype._isBackgroundImage=function(e){return"background"===e.parentNode.getAttribute("data-type")},n.prototype._isUnloadedResponsiveImage=function(e){if(!(t=e)||1!==t.nodeType)throw new TypeError('Odo Responsive Images requires an element. Got: "'+e+'"');var t;if(!e.classList.contains(this.ClassName.IMAGE))throw new TypeError(e+" is not a Odo Responsive Image.");return!0!==e._odoResponsiveImageUsed},n.prototype.isUntrackedImage=function(e){return null===this._getImageIndexByPlaceholder(e)},n.prototype._handleImageLoad=function(e){var t=this,o=e.target;o.parentNode&&(this.updateOffsets(),this._isBackgroundImage(o)?this._updateBackgroundImage(o):this._removeImageHandlers(o),requestAnimationFrame(function(){o.parentNode.classList.add(t.ClassName.LOADED)}))},n.prototype._updateBackgroundImage=function(e){e.parentNode.style.backgroundImage='url("'+(e.currentSrc||e.src)+'")'},n.prototype._update=function(){t.update()},n.prototype._removeImageHandlers=function(e){e&&(e.removeEventListener("load",this._imageLoadHandler,!1),e.removeEventListener("error",this._imageLoadHandler,!1))},n.prototype.flush=function(){var e=this;this.images.forEach(function(o){var r=o.element.querySelector("img");e._removeImageHandlers(r),t.remove(o.id)}),this.images.length=0;var o="."+this.ClassName.IMAGE+'[data-type="background"] img';Array.from(document.querySelectorAll(o)).forEach(function(t){e._removeImageHandlers(t)})},n.prototype.remove=function(e){var t=this;a(e).forEach(function(e){t._removeImageEntry(e),t._removeImageHandlers(e.querySelector("img"))})},n.prototype.add=function(e){var t=a(e).filter(this._isUnloadedResponsiveImage,this).filter(this.isUntrackedImage,this);0!==t.length&&this._add(t)},n.prototype.load=function(e){a(e).filter(this._isUnloadedResponsiveImage,this).forEach(this._loadImage,this)},n}();return n.DEBOUNCE_TIME=300,new n});
//# sourceMappingURL=odo-responsive-images.min.js.map
