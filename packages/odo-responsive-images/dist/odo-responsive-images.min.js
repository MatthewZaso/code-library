!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("picturefill"),require("@odopod/odo-viewport")):"function"==typeof define&&define.amd?define(["picturefill","@odopod/odo-viewport"],t):e.OdoResponsiveImages=t(e.picturefill,e.OdoViewport)}(this,function(e,t){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var r=function(e,t,r){var o,a,n,i,s;function d(){var l=Date.now()-i;l<t&&l>=0?o=setTimeout(d,t-l):(o=null,r||(s=e.apply(n,a),n=a=null))}null==t&&(t=100);var l=function(){n=this,a=arguments,i=Date.now();var l=r&&!o;return o||(o=setTimeout(d,t)),l&&(s=e.apply(n,a),n=a=null),s};return l.clear=function(){o&&(clearTimeout(o),o=null)},l},o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function a(e){return Array.isArray(e)?e:e&&"number"==typeof e.length?Array.from(e):[e]}var n=function(){function n(){o(this,n),this.ClassName={IMAGE:"odo-responsive-img",LOADED:"odo-responsive-img--loaded"},this.images=[],this._imageLoadHandler=this._handleImageLoad.bind(this),this._imageInViewHandler=this._handleImageInView.bind(this),this.updateOffsets=r(this._update,n.DEBOUNCE_TIME)}return n.prototype.initialize=function(){this._add(Array.from(document.querySelectorAll("."+this.ClassName.IMAGE+":not(picture)")))},n.prototype._add=function(e){var r=this,o=e.map(function(e){return r._getViewportOptions(e)}),a=t.add(o);this.images=this.images.concat(a.map(function(t,r){return{id:t,element:e[r]}}))},n.prototype._getViewportOptions=function(e){return{element:e,threshold:e.getAttribute("data-threshold")||0,enter:this._imageInViewHandler}},n.prototype._handleImageInView=function(e){this._loadImage(e.element)},n.prototype._loadImage=function(t){var r=t.querySelector("img");if(!r)throw new Error("Unable to find <img> element within Odo Responsive Images placeholder.");var o=r.getAttribute("data-srcset");if(null!==o)r.srcset=o,r.setAttribute("srcset",o),r.removeAttribute("data-srcset"),t._odoResponsiveImageUsed=!0;else{var a=t.parentElement,n=document.createElement("picture");n.className=t.className,function(e,t){for(var r=document.createDocumentFragment(),o=Array.from(e.childNodes),a=0;a<o.length;a++)"NOSCRIPT"!==o[a].nodeName&&r.appendChild(o[a]);t.appendChild(r)}(t,n);var i=t.getAttribute("data-type");i&&n.setAttribute("data-type",i),r=n.querySelector("img"),a.replaceChild(n,t),n._odoResponsiveImageUsed=!0}this._removeImageEntry(t),this.isImageLoaded(r)&&setTimeout(this._handleImageLoad.bind(this,{target:r}),30),r.addEventListener("load",this._imageLoadHandler,!1),r.addEventListener("error",this._imageLoadHandler,!1),e({elements:[r]})},n.prototype._getImageIndexByPlaceholder=function(e){for(var t=null,r=0,o=this.images.length;r<o;r++)if(this.images[r].element===e){t=r;break}return t},n.prototype._removeImageEntry=function(e){var r=this._getImageIndexByPlaceholder(e);null!==r&&(t.remove(this.images[r].id),this.images.splice(r,1))},n.prototype.isImageLoaded=function(e){return e.naturalWidth>0},n.prototype._isBackgroundImage=function(e){return"background"===e.parentElement.getAttribute("data-type")},n.prototype._isUnloadedResponsiveImage=function(e){if(!(t=e)||1!==t.nodeType)throw new TypeError('Odo Responsive Images requires an element. Got: "'+e+'"');var t;if(!e.classList.contains(this.ClassName.IMAGE))throw new TypeError(e+" is not a Odo Responsive Image.");return!0!==e._odoResponsiveImageUsed},n.prototype.isUntrackedImage=function(e){return null===this._getImageIndexByPlaceholder(e)},n.prototype._handleImageLoad=function(e){var t=this,r=e.target;r.parentNode&&(this.updateOffsets(),this._isBackgroundImage(r)?this._updateBackgroundImage(r):this._removeImageHandlers(r),requestAnimationFrame(function(){r.parentNode.classList.add(t.ClassName.LOADED)}))},n.prototype._updateBackgroundImage=function(e){e.parentNode.style.backgroundImage='url("'+(e.currentSrc||e.src)+'")'},n.prototype._update=function(){t.update()},n.prototype._removeImageHandlers=function(e){e&&(e.removeEventListener("load",this._imageLoadHandler,!1),e.removeEventListener("error",this._imageLoadHandler,!1))},n.prototype.flush=function(){var e=this;this.images.forEach(function(r){var o=r.element.querySelector("img");e._removeImageHandlers(o),t.remove(r.id)}),this.images.length=0;var r="."+this.ClassName.IMAGE+'[data-type="background"] img';Array.from(document.querySelectorAll(r)).forEach(function(t){e._removeImageHandlers(t)})},n.prototype.remove=function(e){var t=this;a(e).forEach(function(e){t._removeImageEntry(e),t._removeImageHandlers(e.querySelector("img"))})},n.prototype.add=function(e){var t=a(e).filter(this._isUnloadedResponsiveImage,this).filter(this.isUntrackedImage,this);0!==t.length&&this._add(t)},n.prototype.load=function(e){a(e).filter(this._isUnloadedResponsiveImage,this).forEach(this._loadImage,this)},n}();return n.DEBOUNCE_TIME=300,new n});
//# sourceMappingURL=odo-responsive-images.min.js.map
